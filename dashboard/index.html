<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sensor Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    h1 { color: #2c3e50; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    .timestamp { font-size: 0.9em; color: #888; }
  </style>
</head>
<body>
  <h1>Live Sensor Dashboard</h1>
  <button onclick="fetchData()">Refresh Sensors</button>
  
  <!-- Relay Control Section -->
  <h2>Relay Control</h2>
  <div id="relay-controls" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px;"></div>
  
  <!-- Sensor Data Section -->
  <h2>Sensor Readings</h2>
  <table id="sensor-table">
    <thead>
      <tr>
        <th>Sensor</th>
        <th>Value</th>
        <th>Unit</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    // Use Cloudflare tunnel URL or localhost for dev
    let API_URL = 'http://localhost:5000'; // Default fallback

    // Fetch the current tunnel URL on page load
    async function initAPI() {
      try {
        // Try to get tunnel URL from server endpoint
        const res = await fetch('/api/tunnel-url', { cache: 'no-store' });
        if (res.ok) {
          const data = await res.json();
          API_URL = data.url || API_URL;
        }
      } catch (e) {
        console.log('Tunnel URL not available, using fallback');
      }
      // Start fetching data
      fetchData();
      fetchRelayStatus();
      setInterval(fetchData, 5000);
      setInterval(fetchRelayStatus, 2000);
    }

    const RELAY_LABELS = {
      1: "Misting Pump",
      2: "Air Pump",
      3: "Exhaust Fan (In)",
      4: "Exhaust Fan (Out)",
      5: "Grow Lights (Aeroponics)",
      6: "Grow Lights (DWC)",
      7: "pH Up",
      8: "pH Down"
    };

    async function fetchData() {
      try {
        const res = await fetch(API_URL + '/api/latest', { cache: 'no-store' });
        const data = await res.json();
        const tbody = document.querySelector('#sensor-table tbody');
        tbody.innerHTML = '';
        Object.entries(data).forEach(([sensor, info]) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${sensor}</td>
            <td>${typeof info.value === 'number' ? info.value.toFixed(2) : info.value}</td>
            <td>${info.unit}</td>
            <td class="timestamp">${info.timestamp}</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Failed to fetch sensors:', err);
      }
    }

    async function fetchRelayStatus() {
      try {
        const res = await fetch(API_URL + '/api/relay/status', { cache: 'no-store' });
        const data = await res.json();
        const container = document.getElementById('relay-controls');
        container.innerHTML = '';
        
        data.relays.forEach(relay => {
          const div = document.createElement('div');
          div.style.cssText = 'border: 1px solid #ccc; padding: 10px; border-radius: 5px; text-align: center;';
          
          const label = document.createElement('div');
          label.textContent = `${RELAY_LABELS[relay.id] || 'Relay ' + relay.id}`;
          label.style.cssText = 'font-weight: bold; margin-bottom: 8px; font-size: 14px;';
          
          const state = document.createElement('div');
          state.textContent = relay.state ? 'üü¢ ON' : 'üî¥ OFF';
          state.style.cssText = 'margin-bottom: 8px; font-size: 16px; font-weight: bold;';
          
          const toggleBtn = document.createElement('button');
          toggleBtn.textContent = relay.state ? 'Turn OFF' : 'Turn ON';
          toggleBtn.style.cssText = 'width: 100%; padding: 8px; cursor: pointer; border-radius: 4px; border: none; background: ' + (relay.state ? '#ff6b6b' : '#51cf66') + '; color: white; font-weight: bold;';
          
          toggleBtn.onclick = async () => {
            toggleBtn.disabled = true;
            toggleBtn.textContent = 'Loading...';
            
            const url = relay.state 
              ? API_URL + '/api/relay/' + relay.id + '/off'
              : API_URL + '/api/relay/' + relay.id + '/on';
            
            try {
              const resp = await fetch(url, { method: 'POST' });
              if (resp.ok) {
                await new Promise(r => setTimeout(r, 100)); // Wait 100ms for ESP32 to execute
                fetchRelayStatus(); // Refresh status
              } else {
                toggleBtn.textContent = relay.state ? 'Turn OFF' : 'Turn ON';
                toggleBtn.disabled = false;
                alert('Failed to toggle relay');
              }
            } catch (err) {
              console.error('Error:', err);
              toggleBtn.textContent = relay.state ? 'Turn OFF' : 'Turn ON';
              toggleBtn.disabled = false;
            }
          };
          
          div.appendChild(label);
          div.appendChild(state);
          div.appendChild(toggleBtn);
          container.appendChild(div);
        });
      } catch (err) {
        console.error('Failed to fetch relays:', err);
      }
    }

    // Initial load
    initAPI();
  </script>
</body>
</html>
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.online { background: #00ff88; }
        .status-dot.offline { background: #ff4444; animation: none; }
        .status-dot.warning { background: #ffaa00; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        
        .card h2 {
            font-size: 1rem;
            color: #888;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h2 .icon {
            font-size: 1.3rem;
        }
        
        .sensor-value {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .sensor-unit {
            color: #888;
            font-size: 1rem;
        }
        
        .sensor-status {
            margin-top: 15px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .status-good { background: rgba(0,255,136,0.2); color: #00ff88; }
        .status-warning { background: rgba(255,170,0,0.2); color: #ffaa00; }
        .status-danger { background: rgba(255,68,68,0.2); color: #ff4444; }
        
        /* Actuator Section */
        .actuators-section {
            margin-top: 30px;
        }
        
        .actuators-section h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .actuator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .actuator-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .actuator-card:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-2px);
        }
        
        .actuator-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .actuator-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: rgba(255,255,255,0.1);
        }
        
        .actuator-details h3 {
            font-size: 1rem;
            margin-bottom: 3px;
        }
        
        .actuator-details p {
            font-size: 0.8rem;
            color: #888;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: 0.3s;
            border-radius: 30px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(90deg, #00d4ff, #00ff88);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        
        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Master Controls */
        .master-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .master-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .master-btn:hover {
            transform: translateY(-2px);
        }
        
        .master-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-all-on {
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            color: #1a1a2e;
        }
        
        .btn-all-off {
            background: #333;
            color: #fff;
            border: 1px solid #555;
        }
        
        .btn-refresh {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        /* Connection Status */
        .connection-status {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .connection-status.connected {
            background: rgba(0,255,136,0.1);
            border: 1px solid rgba(0,255,136,0.3);
            color: #00ff88;
        }
        
        .connection-status.disconnected {
            background: rgba(255,68,68,0.1);
            border: 1px solid rgba(255,68,68,0.3);
            color: #ff4444;
        }
        
        .connection-status code {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .timestamp {
            text-align: center;
            color: #666;
            font-size: 0.8rem;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            header h1 { font-size: 1.8rem; }
            .sensor-value { font-size: 2.5rem; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåä Aquaponics Monitor</h1>
            <p>Real-time Water Quality & Actuator Control</p>
        </header>
        
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="sensorStatus"></div>
                <span>Sensors</span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="relayStatus"></div>
                <span>Actuators</span>
            </div>
            <div class="status-item">
                <span id="lastUpdate">--</span>
            </div>
        </div>
        
        <!-- Sensor Dashboard -->
        <div class="dashboard-grid">
            <div class="card">
                <h2><span class="icon">üå°Ô∏è</span> Temperature</h2>
                <div class="sensor-value" id="tempValue">--</div>
                <div class="sensor-unit">¬∞C</div>
                <div class="sensor-status" id="tempStatus">Loading...</div>
            </div>
            
            <div class="card">
                <h2><span class="icon">üíß</span> Humidity</h2>
                <div class="sensor-value" id="humidityValue">--</div>
                <div class="sensor-unit">%</div>
                <div class="sensor-status" id="humidityStatus">Loading...</div>
            </div>
            
            <div class="card">
                <h2><span class="icon">üß™</span> TDS</h2>
                <div class="sensor-value" id="tdsValue">--</div>
                <div class="sensor-unit">ppm</div>
                <div class="sensor-status" id="tdsStatus">Loading...</div>
            </div>
            
            <div class="card">
                <h2><span class="icon">‚öóÔ∏è</span> pH Level</h2>
                <div class="sensor-value" id="phValue">--</div>
                <div class="sensor-unit">pH</div>
                <div class="sensor-status" id="phStatus">Loading...</div>
            </div>
            
            <div class="card">
                <h2><span class="icon">ü´ß</span> Dissolved Oxygen</h2>
                <div class="sensor-value" id="doValue">--</div>
                <div class="sensor-unit">mg/L</div>
                <div class="sensor-status" id="doStatus">Loading...</div>
            </div>
        </div>
        
        <!-- Actuator Controls -->
        <div class="actuators-section">
            <h2>‚ö° Actuator Controls</h2>
            
            <div class="connection-status disconnected" id="relayConnection">
                <span>‚ö†Ô∏è Relay API not connected - Start relay_api.py locally</span>
            </div>
            
            <div class="master-controls">
                <button class="master-btn btn-all-on" onclick="allRelaysOn()" id="btnAllOn" disabled>
                    <span>‚ö°</span> All ON
                </button>
                <button class="master-btn btn-all-off" onclick="allRelaysOff()" id="btnAllOff" disabled>
                    <span>‚≠ï</span> All OFF
                </button>
                <button class="master-btn btn-refresh" onclick="refreshRelayStatus()">
                    <span>üîÑ</span> Refresh
                </button>
            </div>
            
            <div class="actuator-grid" id="actuatorGrid">
                <!-- Actuator cards generated dynamically -->
            </div>
        </div>
        
        <div class="timestamp">
            Dashboard auto-refreshes every 5 seconds | Deployment: <span id="deployTime">loading...</span>
        </div>
    </div>
    
    <script>
        // API URLs - Using Cloudflare Tunnel to self-hosted RPi
        const SENSOR_API = 'https://lovers-jump-police-fruits.trycloudflare.com/api/latest';
        const RELAY_API = 'https://lovers-jump-police-fruits.trycloudflare.com';  // Same API handles relays
        
        const ACTUATOR_ICONS = {
            "Aerator Pump": "ü´ß", "Water Pump": "üíß", "Heater": "üî•", "Cooler": "‚ùÑÔ∏è",
            "Feeder": "üêü", "Light": "üí°", "Filter": "üîÑ", "Spare": "üîå"
        };
        
        let relayStates = {};
        
        // Fetch sensor data
        async function fetchSensorData() {
            try {
                const response = await fetch(SENSOR_API, { cache: 'no-store' });
                const data = await response.json();
                updateSensorDisplay(data);
                document.getElementById('sensorStatus').className = 'status-dot online';
            } catch (error) {
                console.error('Error fetching sensor data:', error);
                document.getElementById('sensorStatus').className = 'status-dot offline';
            }
        }
        
        function updateSensorDisplay(data) {
            if (data.temperature_c) {
                const temp = parseFloat(data.temperature_c.value).toFixed(1);
                document.getElementById('tempValue').textContent = temp;
                setStatus('tempStatus', getTemperatureStatus(temp));
            }
            if (data.humidity) {
                const humidity = parseFloat(data.humidity.value).toFixed(1);
                document.getElementById('humidityValue').textContent = humidity;
                setStatus('humidityStatus', getHumidityStatus(humidity));
            }
            if (data.tds_ppm) {
                const tds = parseFloat(data.tds_ppm.value).toFixed(0);
                document.getElementById('tdsValue').textContent = tds;
                setStatus('tdsStatus', getTDSStatus(tds));
            }
            if (data.ph) {
                const ph = parseFloat(data.ph.value).toFixed(2);
                document.getElementById('phValue').textContent = ph;
                setStatus('phStatus', getPHStatus(ph));
            }
            if (data.do_mg_l) {
                const dO = parseFloat(data.do_mg_l.value).toFixed(2);
                document.getElementById('doValue').textContent = dO;
                setStatus('doStatus', getDOStatus(dO));
            }
            document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();
        }
        
        function getTemperatureStatus(temp) {
            if (temp >= 24 && temp <= 28) return { text: 'Optimal', class: 'status-good' };
            if (temp >= 20 && temp <= 32) return { text: 'Acceptable', class: 'status-warning' };
            return { text: 'Critical', class: 'status-danger' };
        }
        function getHumidityStatus(h) {
            if (h >= 40 && h <= 70) return { text: 'Optimal', class: 'status-good' };
            if (h >= 30 && h <= 80) return { text: 'Acceptable', class: 'status-warning' };
            return { text: 'Critical', class: 'status-danger' };
        }
        function getTDSStatus(tds) {
            if (tds >= 200 && tds <= 400) return { text: 'Optimal', class: 'status-good' };
            if (tds >= 100 && tds <= 600) return { text: 'Acceptable', class: 'status-warning' };
            return { text: 'Check Levels', class: 'status-danger' };
        }
        function getPHStatus(ph) {
            if (ph >= 6.5 && ph <= 7.5) return { text: 'Optimal', class: 'status-good' };
            if (ph >= 6.0 && ph <= 8.0) return { text: 'Acceptable', class: 'status-warning' };
            return { text: 'Adjust pH', class: 'status-danger' };
        }
        function getDOStatus(dO) {
            if (dO >= 6) return { text: 'Optimal', class: 'status-good' };
            if (dO >= 4) return { text: 'Low', class: 'status-warning' };
            return { text: 'Critical', class: 'status-danger' };
        }
        function setStatus(id, status) {
            const el = document.getElementById(id);
            el.textContent = status.text;
            el.className = 'sensor-status ' + status.class;
        }
        
        // Relay Functions
        async function fetchRelayStatus() {
            try {
                const response = await fetch(`${RELAY_API}/relay/status`);
                const data = await response.json();
                if (data.relays) {
                    updateRelayDisplay(data.relays);
                    document.getElementById('relayStatus').className = 'status-dot online';
                    document.getElementById('relayConnection').className = 'connection-status connected';
                    document.getElementById('relayConnection').innerHTML = '<span>‚úÖ</span> Relay API connected';
                    enableRelayControls(true);
                }
            } catch (error) {
                document.getElementById('relayStatus').className = 'status-dot offline';
                document.getElementById('relayConnection').className = 'connection-status disconnected';
                document.getElementById('relayConnection').innerHTML = 
                    '<span>‚ö†Ô∏è</span> Relay API not connected - Run: <code>python relay_api.py</code>';
                enableRelayControls(false);
            }
        }
        
        function updateRelayDisplay(relays) {
            const grid = document.getElementById('actuatorGrid');
            grid.innerHTML = '';
            relays.forEach(relay => {
                relayStates[relay.id] = relay.state;
                const icon = ACTUATOR_ICONS[relay.label] || 'üîå';
                const card = document.createElement('div');
                card.className = 'actuator-card';
                card.innerHTML = `
                    <div class="actuator-info">
                        <div class="actuator-icon">${icon}</div>
                        <div class="actuator-details">
                            <h3>${relay.label}</h3>
                            <p>Relay ${relay.id} ‚Ä¢ GPIO ${11 + relay.id}</p>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="relay-${relay.id}" 
                               ${relay.state ? 'checked' : ''} 
                               onchange="toggleRelay(${relay.id}, this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                `;
                grid.appendChild(card);
            });
        }
        
        async function toggleRelay(relayId, state) {
            const checkbox = document.getElementById(`relay-${relayId}`);
            checkbox.disabled = true;
            try {
                const action = state ? 'on' : 'off';
                const response = await fetch(`${RELAY_API}/relay/${relayId}/${action}`, { method: 'POST' });
                const data = await response.json();
                if (!data.success) checkbox.checked = !state;
            } catch (error) {
                checkbox.checked = !state;
            }
            checkbox.disabled = false;
        }
        
        async function allRelaysOn() {
            document.getElementById('btnAllOn').disabled = true;
            try {
                const response = await fetch(`${RELAY_API}/relay/all/on`, { method: 'POST' });
                const data = await response.json();
                if (data.success) updateRelayDisplay(data.relays);
            } catch (error) {}
            document.getElementById('btnAllOn').disabled = false;
        }
        
        async function allRelaysOff() {
            document.getElementById('btnAllOff').disabled = true;
            try {
                const response = await fetch(`${RELAY_API}/relay/all/off`, { method: 'POST' });
                const data = await response.json();
                if (data.success) updateRelayDisplay(data.relays);
            } catch (error) {}
            document.getElementById('btnAllOff').disabled = false;
        }
        
        function refreshRelayStatus() { fetchRelayStatus(); }
        
        function enableRelayControls(enabled) {
            document.getElementById('btnAllOn').disabled = !enabled;
            document.getElementById('btnAllOff').disabled = !enabled;
            for (let i = 1; i <= 8; i++) {
                const cb = document.getElementById(`relay-${i}`);
                if (cb) cb.disabled = !enabled;
            }
        }
        
        // Show deployment time (verifies Vercel updated)
        document.getElementById('deployTime').textContent = new Date().toLocaleString();
        
        // Initialize
        fetchSensorData();
        fetchRelayStatus();
        setInterval(fetchSensorData, 5000);
        setInterval(fetchRelayStatus, 10000);
    </script>
</body>
</html>
